{% extends 'base.html' %}

{% block breadcrumb-left %}
<div class="breadcrumb-container">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-chevron">
      <li class="breadcrumb-item">
        <a href="{% url 'home' %}" class="text-decoration-none fw-bold">
          <i class="fas fa-home"></i> Home
        </a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'student-list' %}" class="text-decoration-none fw-bold">
          <i class="fas fa-user-graduate"></i> Students
        </a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'student-list' %}" class="text-decoration-none fw-bold">
          <i class="fas fa-list"></i> List
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        <i class="fas fa-plus-circle"></i> Form
      </li>
    </ol>
  </nav>
</div>
{% endblock breadcrumb-left %}

{% block title %}
  {% if object %}
    Update {{ object }}
  {% else %}
    Add new student
  {% endif %}
{% endblock title %}

{% block content %}
<form action="" method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {% include 'corecode/form_snippet.html' with placeholders=True %}
  {% if object %}
    <input type="submit" class="btn btn-primary" value="Update Record">
  {% else %}
    <input type="submit" class="btn btn-primary" value="Add new student">
  {% endif %}
</form>
{% endblock content %}

{% block morejs %}
<script>
  // Function to load sections for a class
  function loadSections(classId) {
    if (!classId) {
      // Clear the section dropdown if no class is selected
      var sectionField = document.querySelector('select[name="section"]');
      sectionField.innerHTML = '<option value="">-- Select Section --</option>';
      return;
    }

    // Make AJAX call to get sections for this class
    $.ajax({
      url: '/student/api/class/' + classId + '/sections/',
      type: 'GET',
      success: function(data) {
        var sectionField = document.querySelector('select[name="section"]');
        sectionField.innerHTML = '<option value="">-- Select Section --</option>';

        if (data.sections && data.sections.length > 0) {
          // Add sections to dropdown
          data.sections.forEach(function(section) {
            var option = document.createElement('option');
            option.value = section.id;
            option.textContent = section.name;
            sectionField.appendChild(option);
          });
        }
      },
      error: function(xhr) {
        console.error('Error loading sections:', xhr.responseText);
      }
    });
  }

  // Load sections when the page loads (for edit form)
  $(document).ready(function() {
    var classField = document.querySelector('select[name="current_class"]');
    if (classField && classField.value) {
      loadSections(classField.value);

      // Set the current section as selected after sections are loaded
      setTimeout(function() {
        var sectionField = document.querySelector('select[name="section"]');
        var currentSection = '{{ object.section|default:"" }}';

        if (currentSection && sectionField) {
          // Find and select the option with the current section value
          for (var i = 0; i < sectionField.options.length; i++) {
            if (sectionField.options[i].textContent === currentSection) {
              sectionField.options[i].selected = true;
              break;
            }
          }
        }
      }, 500); // Small delay to ensure sections are loaded
    }
  });
</script>
{% endblock morejs %}
