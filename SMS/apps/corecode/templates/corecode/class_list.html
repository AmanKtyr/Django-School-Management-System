{% extends 'base.html' %}
{% load widget_tweaks %}

{% block breadcrumb-left %}
<div class="breadcrumb-container">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-chevron">
      <li class="breadcrumb-item">
        <a href="{% url 'home' %}" class="text-decoration-none fw-bold">
          <i class="fas fa-home"></i> Home
        </a>
      </li>
      <li class="breadcrumb-item">
        <a href="#" class="text-decoration-none fw-bold">
          <i class="fas fa-copy"></i> Management
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        <i class="fas fa-school"></i> Classes
      </li>
    </ol>
  </nav>
</div>
{% endblock breadcrumb-left %}

{% block title-icon %}fas fa-school{% endblock title-icon %}

{% block title %}Class Management{% endblock title %}

{% block subtitle %}Create and manage academic classes for your institution{% endblock subtitle %}

{% block page-actions %}
<a class="btn btn-primary" href="#" id="addClassBtn">
  <i class="fas fa-plus me-2"></i> Add New Class
</a>
{% endblock page-actions %}

{% block breadcrumb %}
{% endblock breadcrumb %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-6">
    <div class="input-group">
      <span class="input-group-text bg-primary text-white"><i class="fas fa-search"></i></span>
      <input type="text" id="classSearchInput" class="form-control" placeholder="Search classes...">
    </div>
  </div>
  <div class="col-md-6 text-end">
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary" id="refreshClassList">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-sort"></i> Sort
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item sort-option" data-sort="name-asc" href="#">Name (A-Z)</a></li>
          <li><a class="dropdown-item sort-option" data-sort="name-desc" href="#">Name (Z-A)</a></li>
          <li><a class="dropdown-item sort-option" data-sort="students-asc" href="#">Students (Low-High)</a></li>
          <li><a class="dropdown-item sort-option" data-sort="students-desc" href="#">Students (High-Low)</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-sm-12">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="fas fa-list me-2"></i> Class List
          <span class="badge bg-primary ms-2" id="totalClassCount">{{ object_list|length }}</span>
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-striped" id="classTable">
            <thead class="table-light">
              <tr>
                <th width="5%" class="text-center">#</th>
                <th width="40%">Class Name</th>
                <th width="15%" class="text-center">Students</th>
                <th width="25%" class="text-center">Sections</th>
                <th width="15%" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for object in object_list %}
              <tr class="class-row" data-class-id="{{ object.id }}" data-class-name="{{ object }}">
                <td class="text-center">{{ forloop.counter }}</td>
                <td>
                  <span class="fw-medium">{{ object }}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-info student-count" data-class-id="{{ object.id }}">Loading...</span>
                </td>
                <td class="text-center">
                  <span class="section-list" data-class-id="{{ object.id }}">Loading...</span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <a href="{% url 'class-update' object.id %}" class="btn btn-outline-primary" title="Edit Class">
                      <i class="fa fa-edit"></i>
                    </a>
                    <button type="button" class="btn btn-outline-info view-class-details" data-class-id="{{ object.id }}" title="View Details">
                      <i class="fa fa-eye"></i>
                    </button>
                    <a href="{% url 'class-delete' object.id %}" class="btn btn-outline-danger" title="Delete Class">
                      <i class="fa fa-trash-alt"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4">
                  <div class="empty-state">
                    <i class="fas fa-school fa-3x text-muted mb-3"></i>
                    <h5>No Classes Found</h5>
                    <p class="text-muted">Start by adding your first class using the 'Add New Class' button.</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Showing {{ object_list|length }} classes</small>
          </div>
          <div>
            <nav aria-label="Class navigation">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item disabled">
                  <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                </li>
                <li class="page-item active" aria-current="page">
                  <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#">Next</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Class Details Modal -->
<div class="modal fade" id="classDetailsModal" tabindex="-1" aria-labelledby="classDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="classDetailsModalLabel">
          <i class="fas fa-info-circle me-2"></i> Class Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">Class Name:</label>
              <p id="detailClassName" class="form-control-plaintext">-</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">Total Students:</label>
              <p id="detailStudentCount" class="form-control-plaintext">-</p>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label fw-bold">Sections:</label>
              <div id="detailSections" class="form-control-plaintext">Loading...</div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label fw-bold">Subjects:</label>
              <div id="detailSubjects" class="form-control-plaintext">Loading...</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" id="editClassLink" class="btn btn-primary">
          <i class="fas fa-edit me-1"></i> Edit Class
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add New Class Modal -->
<div class="modal fade" id="modal1" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{% url 'class-create' %}" method="POST" id="addClassForm">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="addClassModalLabel">
            <i class="fas fa-plus-circle me-2"></i> Add New Class
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Enter the class name (e.g., "Class 1", "Grade 10", "First Year").
          </div>
          {% for field in form %}
          <div class="mb-3">
            <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
            {{ field|add_class:"form-control" }}
            <div class="form-text">{{ field.help_text }}</div>
            <div class="invalid-feedback">{{ field.errors }}</div>
          </div>
          {% endfor %}
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Save Class
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block morejs %}
<script>
  $(document).ready(function() {
    // Handle the Add Class button click
    $('#addClassBtn').on('click', function(e) {
      e.preventDefault();
      var modal = new bootstrap.Modal(document.getElementById('modal1'));
      modal.show();
    });

    // Search functionality
    $('#classSearchInput').on('keyup', function() {
      var value = $(this).val().toLowerCase();
      $('#classTable tbody tr').filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
      });
      updateEmptyState();
    });

    // Refresh button
    $('#refreshClassList').on('click', function() {
      location.reload();
    });

    // Sort functionality
    $('.sort-option').on('click', function(e) {
      e.preventDefault();
      var sortType = $(this).data('sort');
      sortTable(sortType);
    });

    // View class details
    $('.view-class-details').on('click', function() {
      var classId = $(this).data('class-id');
      var className = $(this).closest('tr').data('class-name');
      var studentCount = $(this).closest('tr').find('.student-count').text();
      var sections = $(this).closest('tr').find('.section-list').html(); // Use HTML to preserve badges

      $('#detailClassName').text(className);
      $('#detailStudentCount').text(studentCount);
      $('#detailSections').html(sections);
      $('#editClassLink').attr('href', '/class/' + classId + '/update/');

      // Load subjects for this class
      loadSubjectsForClass(classId);

      var detailsModal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
      detailsModal.show();
    });

    // Load student counts and sections for each class
    loadClassData();

    // Function to load student counts and sections
    function loadClassData() {
      $('.class-row').each(function() {
        var row = $(this);
        var classId = row.data('class-id');

        // Make AJAX call to get student count and sections
        $.ajax({
          url: '/class/' + classId + '/data/',
          type: 'GET',
          success: function(data) {
            // Update student count
            row.find('.student-count').text(data.student_count || 0);

            // Update sections
            if (data.sections && data.sections.length > 0) {
              var sectionHtml = '';
              data.sections.forEach(function(section, index) {
                sectionHtml += '<span class="badge bg-secondary me-1">' + section + '</span>';
              });
              row.find('.section-list').html(sectionHtml);
            } else {
              row.find('.section-list').html('<span class="text-muted">No sections</span>');
            }
          },
          error: function() {
            row.find('.student-count').text('0');
            row.find('.section-list').html('<span class="text-muted">No sections</span>');
          }
        });
      });
    }

    // Function to load subjects for a class
    function loadSubjectsForClass(classId) {
      $('#detailSubjects').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading subjects...</div>');

      // Make AJAX call to get subjects
      $.ajax({
        url: '/class/' + classId + '/data/',
        type: 'GET',
        success: function(data) {
          var subjectsHtml = '<div class="row">';

          if (data.subjects && data.subjects.length > 0) {
            data.subjects.forEach(function(subject) {
              subjectsHtml += '<div class="col-md-4 mb-2"><span class="badge bg-light text-dark p-2 d-block text-start"><i class="fas fa-book me-1"></i> ' + subject + '</span></div>';
            });
          } else {
            subjectsHtml += '<div class="col-12"><p class="text-muted">No subjects assigned to this class yet.</p></div>';
          }

          subjectsHtml += '</div>';
          $('#detailSubjects').html(subjectsHtml);
        },
        error: function() {
          $('#detailSubjects').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i> Unable to load subjects for this class.</div>');
        }
      });
    }

    // Function to sort the table
    function sortTable(sortType) {
      var rows = $('#classTable tbody tr').get();

      rows.sort(function(a, b) {
        var keyA, keyB;

        if (sortType === 'name-asc' || sortType === 'name-desc') {
          keyA = $(a).data('class-name').toUpperCase();
          keyB = $(b).data('class-name').toUpperCase();
        } else if (sortType === 'students-asc' || sortType === 'students-desc') {
          keyA = parseInt($(a).find('.student-count').text()) || 0;
          keyB = parseInt($(b).find('.student-count').text()) || 0;
        }

        if (sortType === 'name-asc' || sortType === 'students-asc') {
          return keyA > keyB ? 1 : -1;
        } else {
          return keyA < keyB ? 1 : -1;
        }
      });

      $.each(rows, function(index, row) {
        $('#classTable tbody').append(row);
        $(row).find('td:first').text(index + 1); // Update the serial numbers
      });
    }

    // Function to update empty state when filtering
    function updateEmptyState() {
      var visibleRows = $('#classTable tbody tr:visible').length;
      if (visibleRows === 0) {
        if ($('#classTable tbody .empty-filtered-state').length === 0) {
          $('#classTable tbody').append('<tr class="empty-filtered-state"><td colspan="5" class="text-center py-4"><div class="empty-state"><i class="fas fa-filter fa-3x text-muted mb-3"></i><h5>No Matching Classes</h5><p class="text-muted">No classes match your search criteria.</p></div></td></tr>');
        }
      } else {
        $('#classTable tbody .empty-filtered-state').remove();
      }
    }

    // Form validation
    $('#addClassForm').on('submit', function(e) {
      var form = $(this);
      var nameField = form.find('input[name="name"]');
      var isValid = true;

      if (!nameField.val().trim()) {
        nameField.addClass('is-invalid');
        nameField.siblings('.invalid-feedback').text('Class name is required');
        isValid = false;
      } else {
        nameField.removeClass('is-invalid');
      }

      return isValid;
    });

    // Function to handle AJAX errors
    $(document).ajaxError(function(event, jqXHR, settings, thrownError) {
      if (settings.url.includes('/class/') && settings.url.includes('/data/')) {
        var row = $('.class-row[data-class-id="' + settings.url.split('/')[2] + '"]');
        row.find('.student-count').text('0');
        row.find('.section-list').html('<span class="text-muted">No sections</span>');
        console.error('Error loading class data:', thrownError);
      }
    });
  });
</script>
{% endblock morejs %}
